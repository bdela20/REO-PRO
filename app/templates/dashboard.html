{% extends "base.html" %}

{% block title %}Agent Dashboard - Real Estate Office Pro{% endblock %}

{% block styles %}
<style>
    .dashboard-container {
        margin-top: 1rem;
    }
    
    /* Welcome Section */
    .welcome-section {
        background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
        color: white;
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }
    
    .welcome-section::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 200px;
        height: 200px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        transform: translate(50px, -50px);
    }
    
    .welcome-section h1 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        font-weight: 700;
        position: relative;
        z-index: 1;
    }
    
    .welcome-section p {
        opacity: 0.9;
        font-size: 1.1rem;
        position: relative;
        z-index: 1;
    }
    
    /* Stats Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid #e2e8f0;
        text-align: center;
        transition: all 0.3s;
        position: relative;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
        border-radius: 12px 12px 0 0;
    }
    
    .stat-card h3 {
        font-size: 0.75rem;
        color: #64748b;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 600;
    }
    
    .stat-card .stat-value {
        font-size: 2rem;
        font-weight: 800;
        color: #1e293b;
        margin-bottom: 0.25rem;
    }
    
    .stat-card .stat-change {
        font-size: 0.75rem;
        color: #10b981;
        font-weight: 500;
    }
    
    /* Features Preview */
    .features-preview {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        border: 1px solid #e2e8f0;
        position: relative;
        overflow: hidden;
    }
    
    .features-preview::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(135deg, #2563eb 0%, #3b82f6 50%, #10b981 100%);
    }
    
    .features-preview-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .features-preview-header h2 {
        font-size: 1.75rem;
        color: #1e293b;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .features-preview-header p {
        color: #64748b;
        font-size: 1rem;
        margin: 0;
    }
    
    .features-preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.5rem;
    }
    
    .feature-preview-card {
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.5rem;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .feature-preview-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(135deg, var(--card-color, #2563eb) 0%, var(--card-color-light, #3b82f6) 100%);
        opacity: 0.8;
    }
    
    .feature-preview-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        border-color: var(--card-color, #2563eb);
    }
    
    /* Card Color Variants */
    .feature-preview-card:nth-child(1) {
        --card-color: #2563eb;
        --card-color-light: #3b82f6;
    }
    
    .feature-preview-card:nth-child(2) {
        --card-color: #10b981;
        --card-color-light: #34d399;
    }
    
    .feature-preview-card:nth-child(3) {
        --card-color: #f59e0b;
        --card-color-light: #fbbf24;
    }
    
    .feature-preview-card:nth-child(4) {
        --card-color: #8b5cf6;
        --card-color-light: #a78bfa;
    }
    
    .feature-preview-card:nth-child(5) {
        --card-color: #ef4444;
        --card-color-light: #f87171;
    }
    
    .feature-preview-card:nth-child(6) {
        --card-color: #06b6d4;
        --card-color-light: #22d3ee;
    }
    
    .feature-preview-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.5rem;
    }
    
    .feature-preview-icon {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        background: linear-gradient(135deg, var(--card-color, #2563eb) 0%, var(--card-color-light, #3b82f6) 100%);
        margin-right: 1rem;
        flex-shrink: 0;
    }
    
    .feature-preview-header h3 {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1e293b;
        margin: 0;
        flex: 1;
    }
    
    .feature-preview-trend {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        white-space: nowrap;
    }
    
    .feature-preview-trend.up {
        background: #dcfce7;
        color: #166534;
    }
    
    .feature-preview-trend.down {
        background: #fef2f2;
        color: #dc2626;
    }
    
    .feature-preview-trend.neutral {
        background: #f1f5f9;
        color: #475569;
    }
    
    .feature-preview-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .stat-item {
        text-align: center;
        padding: 0.75rem 0.5rem;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
        border: 1px solid #f1f5f9;
        transition: all 0.3s ease;
    }
    
    .stat-item:hover {
        background: rgba(255, 255, 255, 0.9);
        transform: translateY(-1px);
    }
    
    .stat-number {
        display: block;
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 0.25rem;
    }
    
    .stat-label {
        font-size: 0.75rem;
        color: #64748b;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }
    
    .feature-preview-footer {
        text-align: center;
    }
    
    .feature-preview-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: var(--card-color, #2563eb);
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .feature-preview-link:hover {
        background: var(--card-color-light, #3b82f6);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .feature-preview-link::after {
        content: '→';
        font-weight: bold;
        transition: transform 0.3s ease;
    }
    
    .feature-preview-link:hover::after {
        transform: translateX(2px);
    }
    
    /* Quick Actions */
    .quick-actions {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        border: 1px solid #e2e8f0;
    }
    
    .quick-actions-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    
    .quick-actions h2 {
        font-size: 1.5rem;
        color: #1e293b;
        font-weight: 700;
        margin: 0;
    }
    
    .action-controls {
        display: flex;
        gap: 0.5rem;
    }
    
    .control-btn {
        padding: 0.5rem 1rem;
        border: 1px solid #e2e8f0;
        background: white;
        border-radius: 8px;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.3s;
        color: #64748b;
    }
    
    .control-btn:hover {
        background: #f8fafc;
        border-color: #2563eb;
        color: #2563eb;
    }
    
    .control-btn.active {
        background: #2563eb;
        color: white;
        border-color: #2563eb;
    }
    
    .actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        position: relative;
    }
    
    .action-card {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.5rem;
        text-decoration: none;
        color: inherit;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 1rem;
        position: relative;
        cursor: move;
    }
    
    .action-card.dragging {
        opacity: 0.5;
        transform: scale(1.05);
        cursor: grabbing;
    }
    
    .action-card.drag-over {
        border-color: #2563eb;
        background: #eff6ff;
    }
    
    .action-card:hover {
        background: white;
        border-color: #2563eb;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
    }
    
    .action-card.edit-mode {
        padding-top: 2.5rem;
    }
    
    .delete-btn {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        width: 24px;
        height: 24px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        line-height: 1;
        transition: all 0.3s;
    }
    
    .edit-mode .delete-btn {
        display: flex;
    }
    
    .delete-btn:hover {
        background: #dc2626;
        transform: scale(1.1);
    }
    
    .action-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.25rem;
        flex-shrink: 0;
    }
    
    /* Support for emoji icons */
    .action-icon.emoji-icon {
        background: white;
        border: 2px solid #e2e8f0;
        font-size: 1.5rem;
    }
    
    .action-content h3 {
        font-size: 1rem;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 0.25rem;
    }
    
    .action-content p {
        font-size: 0.875rem;
        color: #64748b;
        margin: 0;
    }
    
    /* Add New Action */
    .add-action-card {
        background: #f8fafc;
        border: 2px dashed #e2e8f0;
        border-radius: 12px;
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 120px;
        color: #94a3b8;
    }
    
    .add-action-card:hover {
        border-color: #2563eb;
        background: white;
        color: #2563eb;
    }
    
    .add-action-content {
        text-align: center;
    }
    
    .add-action-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
    
    /* Add Action Modal */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    
    .modal-overlay.active {
        display: flex;
    }
    
    .modal {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    }
    
    .modal h3 {
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
        color: #1e293b;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #475569;
        font-size: 0.875rem;
    }
    
    .form-group input,
    .form-group select {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s;
    }
    
    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .modal-actions {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }
    
    .modal-actions button {
        flex: 1;
        padding: 0.75rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-cancel {
        background: white;
        border: 2px solid #e2e8f0;
        color: #64748b;
    }
    
    .btn-cancel:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
    }
    
    .btn-save {
        background: #2563eb;
        border: 2px solid #2563eb;
        color: white;
    }
    
    .btn-save:hover {
        background: #1d4ed8;
        border-color: #1d4ed8;
    }
    
    /* Plan upgrade section */
    .plan-upgrade {
        background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
        color: white;
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        margin-top: 2rem;
    }
    
    .plan-upgrade h3 {
        font-size: 1.25rem;
        margin-bottom: 0.5rem;
        font-weight: 700;
    }
    
    .plan-upgrade p {
        margin-bottom: 1rem;
        opacity: 0.9;
    }
    
    /* Pricing Modal Styles */
    .close-modal {
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 32px;
        height: 32px;
        background: #f1f5f9;
        border: none;
        border-radius: 8px;
        font-size: 1.5rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
    }
    
    .close-modal:hover {
        background: #e2e8f0;
        transform: scale(1.1);
    }
    
    .pricing-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 2rem;
        margin-top: 2rem;
    }
    
    .pricing-card {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 16px;
        padding: 2rem;
        position: relative;
        transition: all 0.3s;
    }
    
    .pricing-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    }
    
    .pricing-card.featured {
        border-color: #2563eb;
        transform: scale(1.05);
    }
    
    .popular-badge {
        position: absolute;
        top: -12px;
        left: 50%;
        transform: translateX(-50%);
        background: #2563eb;
        color: white;
        padding: 0.25rem 1rem;
        border-radius: 16px;
        font-size: 0.875rem;
        font-weight: 600;
    }
    
    .plan-header {
        text-align: center;
        margin-bottom: 2rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .plan-name {
        font-size: 1.5rem;
        margin-bottom: 1rem;
        color: #1e293b;
    }
    
    .plan-price {
        display: flex;
        align-items: baseline;
        justify-content: center;
        margin-bottom: 0.5rem;
    }
    
    .currency {
        font-size: 1.5rem;
        color: #64748b;
        margin-right: 0.25rem;
    }
    
    .amount {
        font-size: 3rem;
        font-weight: 800;
        color: #1e293b;
    }
    
    .period {
        font-size: 1.25rem;
        color: #64748b;
        margin-left: 0.25rem;
    }
    
    .plan-description {
        color: #64748b;
        margin: 0;
    }
    
    .plan-features {
        list-style: none;
        padding: 0;
        margin-bottom: 2rem;
    }
    
    .plan-features li {
        padding: 0.75rem 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: #475569;
    }
    
    .plan-features li.disabled {
        color: #cbd5e1;
    }
    
    .check {
        color: #10b981;
        font-weight: bold;
    }
    
    .x {
        color: #cbd5e1;
    }
    
    .plan-button {
        width: 100%;
        padding: 0.875rem;
        border: 2px solid #e2e8f0;
        background: white;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        color: #64748b;
    }
    
    .plan-button:hover:not(:disabled) {
        background: #f8fafc;
        border-color: #2563eb;
        color: #2563eb;
    }
    
    .plan-button.current {
        background: #f1f5f9;
        cursor: not-allowed;
    }
    
    .plan-button.featured-btn {
        background: #2563eb;
        color: white;
        border-color: #2563eb;
    }
    
    .plan-button.featured-btn:hover {
        background: #1d4ed8;
        border-color: #1d4ed8;
    }
    
    /* Payment Modal Styles */
    .selected-plan-summary {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .selected-plan-summary h4 {
        margin: 0 0 0.5rem 0;
        font-size: 1.25rem;
        color: #1e293b;
    }
    
    .selected-plan-summary p {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: #2563eb;
    }
    
    #payment-form .form-group {
        margin-bottom: 1.25rem;
    }
    
    #payment-form input[type="checkbox"] {
        margin-right: 0.5rem;
    }
    
    /* Dashboard-specific Buttons */
    .dashboard-container .btn,
    .modal .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s;
        border: none;
        cursor: pointer;
    }
    
    .dashboard-container .btn:hover,
    .modal .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .dashboard-container .btn-primary,
    .modal .btn-primary {
        background: #2563eb;
        color: white;
    }
    
    .dashboard-container .btn-primary:hover,
    .modal .btn-primary:hover {
        background: #1d4ed8;
    }
    
    .dashboard-container .btn-secondary,
    .modal .btn-secondary {
        background: #64748b;
        color: white;
    }
    
    .dashboard-container .btn-secondary:hover,
    .modal .btn-secondary:hover {
        background: #475569;
    }
    
    /* Button utilities */
    .btn.btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }

    /* Welcome Modal Styles for Dashboard */
    .welcome-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        animation: fadeIn 0.3s ease-out;
    }
    
    .welcome-overlay.show {
        display: flex !important;
    }
    
    .welcome-modal {
        background: white;
        border-radius: 16px;
        padding: 3rem;
        text-align: center;
        max-width: 400px;
        width: 90%;
        animation: slideUp 0.3s ease-out;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }
    
    .welcome-icon {
        margin-bottom: 1.5rem;
        animation: bounce 0.5s ease-out 0.3s;
    }
    
    .welcome-modal h2 {
        color: #1e293b;
        font-size: 1.75rem;
        margin-bottom: 1rem;
        font-weight: 700;
    }
    
    .welcome-modal p {
        color: #64748b;
        margin-bottom: 0.5rem;
        font-size: 1.1rem;
    }
    
    .welcome-subtitle {
        color: #6366f1;
        font-weight: 600;
        margin-bottom: 2rem !important;
    }
    
    .btn-welcome {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 0.875rem 2.5rem;
        font-size: 1rem;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-welcome:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes slideUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    @keyframes bounce {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .actions-grid {
            grid-template-columns: 1fr;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .features-preview-grid {
            grid-template-columns: 1fr;
        }
        
        .features-preview {
            padding: 1.5rem;
        }
        
        .feature-preview-stats {
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }
        
        .feature-preview-card {
            padding: 1.25rem;
        }
        
        .features-preview-header h2 {
            font-size: 1.5rem;
        }
    }
    
    @media (max-width: 480px) {
        .features-preview-header {
            margin-bottom: 1.5rem;
        }
        
        .feature-preview-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .feature-preview-icon {
            margin-right: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Welcome Section -->
    <div class="welcome-section">
        <h1>Welcome back, {{ session.user_name }}!</h1>
        <p>Your real estate command center is ready. What would you like to accomplish today?</p>
    </div>
    
    <!-- Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <h3>Current Plan</h3>
            <div class="stat-value">{{ session.user_plan|upper }}</div>
            <div class="stat-change">Active</div>
        </div>
        <div class="stat-card">
            <h3>CRM Client Count</h3>
            <div class="stat-value" id="client-searches">UNLIMITED</div>
            <div class="stat-change">Full Access</div>
        </div>
    </div>
    
    <!-- Features Preview -->
    <div class="features-preview">
        <div class="features-preview-header">
            <h2>Your Business at a Glance</h2>
            <p>Real-time insights from your complete real estate platform</p>
        </div>
        <div class="features-preview-grid">
            <!-- CRM Preview -->
            <div class="feature-preview-card">
                <div class="feature-preview-header">
                    <div class="feature-preview-icon crm-icon">
                        <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1H7zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
                            <path fill-rule="evenodd" d="M5.216 14A2.238 2.238 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.325 6.325 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1h4.216z"/>
                            <path d="M4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5z"/>
                        </svg>
                    </div>
                    <h3>Client Management</h3>
                    <span class="feature-preview-trend neutral">Today</span></span>
                </div>
                <div class="feature-preview-stats">
                    <div class="stat-item">
                        <span class="stat-number">0</span>
                        <span class="stat-label">Total Leads</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">0</span>
                        <span class="stat-label">Active Clients</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">0</span>
                        <span class="stat-label">Need Follow-up</span>
                    </div>
                </div>
                <div class="feature-preview-footer">
                    <a href="/crm" class="feature-preview-link">View CRM Dashboard</a>
                </div>
            </div>

            <!-- Documents & E-sign Preview -->
            <div class="feature-preview-card">
                <div class="feature-preview-header">
                    <div class="feature-preview-icon documents-icon">
                        <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
                            <path d="M4.603 14.087a.81.81 0 0 1-.438-.42c-.195-.388-.13-.776.08-1.102.198-.307.526-.568.897-.787a7.68 7.68 0 0 1 1.482-.645 19.697 19.697 0 0 0 1.062-2.227 7.269 7.269 0 0 1-.43-1.295c-.086-.4-.119-.796-.046-1.136.075-.354.274-.672.65-.823.192-.077.4-.12.602-.077a.7.7 0 0 1 .477.365c.088.164.12.356.127.538.007.188-.012.396-.047.614-.084.51-.27 1.134-.52 1.794a10.954 10.954 0 0 0 .98 1.686 5.753 5.753 0 0 1 1.334.05c.364.066.734.195.96.465.12.144.193.32.2.518.007.192-.047.382-.138.563a1.04 1.04 0 0 1-.354.416.856.856 0 0 1-.51.138c-.331-.014-.654-.196-.933-.417a5.712 5.712 0 0 1-.911-.95 11.651 11.651 0 0 0-1.997.406 11.307 11.307 0 0 1-1.02 1.51c-.292.35-.609.656-.927.787a.793.793 0 0 1-.58.029zm1.379-1.901c-.166.076-.32.156-.459.238-.328.194-.541.383-.647.547-.094.145-.096.25-.04.361.01.022.02.036.026.044a.266.266 0 0 0 .035-.012c.137-.056.355-.235.635-.572a8.18 8.18 0 0 0 .45-.606zm1.64-1.33a12.71 12.71 0 0 1 1.01-.193 11.744 11.744 0 0 1-.51-.858 20.801 20.801 0 0 1-.5 1.05zm2.446.45c.15.163.296.3.435.41.24.19.407.253.498.256a.107.107 0 0 0 .07-.015.307.307 0 0 0 .094-.125.436.436 0 0 0 .059-.2.095.095 0 0 0-.026-.063c-.052-.062-.2-.152-.518-.209a3.876 3.876 0 0 0-.612-.053zM8.078 7.8a6.7 6.7 0 0 0 .2-.828c.031-.188.043-.343.038-.465a.613.613 0 0 0-.032-.198.517.517 0 0 0-.145.04c-.087.035-.158.106-.196.283-.04.192-.03.469.046.706.061.19.152.394.13.572-.016.128-.032.25-.04.37z"/>
                        </svg>
                    </div>
                    <h3>Documents & E-sign</h3>
                    <span class="feature-preview-trend up">+5%</span>
                </div>
                <div class="feature-preview-stats">
                    <div class="stat-item">
                        <span class="stat-number">14</span>
                        <span class="stat-label">Signed Contracts</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">6</span>
                        <span class="stat-label">Pending Signatures</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">127</span>
                        <span class="stat-label">Total Documents</span>
                    </div>
                </div>
                <div class="feature-preview-footer">
                    <a href="/documents" class="feature-preview-link">Manage Documents</a>
                </div>
            </div>

            <!-- Calendar & Scheduling Preview -->
            <div class="feature-preview-card">
                <div class="feature-preview-header">
                    <div class="feature-preview-icon calendar-icon">
                        <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5 0zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/>
                        </svg>
                    </div>
                    <h3>Calendar & Scheduling</h3>
                    <span class="feature-preview-trend neutral">Today</span>
                </div>
                <div class="feature-preview-stats">
                    <div class="stat-item">
                        <span class="stat-number">9</span>
                        <span class="stat-label">Today's Showings</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">23</span>
                        <span class="stat-label">This Week</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">156</span>
                        <span class="stat-label">Total This Month</span>
                    </div>
                </div>
                <div class="feature-preview-footer">
                    <a href="/calendar" class="feature-preview-link">View Schedule</a>
                </div>
            </div>

            <!-- Education Center Preview -->
            <div class="feature-preview-card">
                <div class="feature-preview-header">
                    <div class="feature-preview-icon education-icon">
                        <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8.211 2.047a.5.5 0 0 0-.422 0l-7.5 3.5a.5.5 0 0 0 .025.917l7.5 3a.5.5 0 0 0 .372 0L14 7.14V13a1 1 0 0 0-1 1v2h3v-2a1 1 0 0 0-1-1V6.739l.686-.275a.5.5 0 0 0 .025-.917l-7.5-3.5ZM8 8.46 1.758 5.965 8 3.052l6.242 2.913L8 8.46Z"/>
                            <path d="M4.176 9.032a.5.5 0 0 0-.656.327l-.5 1.7a.5.5 0 0 0 .294.605l4.5 1.8a.5.5 0 0 0 .372 0l4.5-1.8a.5.5 0 0 0 .294-.605l-.5-1.7a.5.5 0 0 0-.656-.327L8 10.466 4.176 9.032Zm-.068 1.873.22-.748 3.496 1.311a.5.5 0 0 0 .352 0l3.496-1.311.22.748L8 12.46l-3.892-1.555Z"/>
                        </svg>
                    </div>
                    <h3>Education Center</h3>
                    <span class="feature-preview-trend up">+2 New</span>
                </div>
                <div class="feature-preview-stats">
                    <div class="stat-item">
                        <span class="stat-number">12</span>
                        <span class="stat-label">Courses Completed</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">78%</span>
                        <span class="stat-label">Progress Rate</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">4.2h</span>
                        <span class="stat-label">Learning Time</span>
                    </div>
                </div>
                <div class="feature-preview-footer">
                    <a href="/education" class="feature-preview-link">Continue Learning</a>
                </div>
            </div>

            <!-- Market Analytics Preview -->
            <div class="feature-preview-card">
                <div class="feature-preview-header">
                    <div class="feature-preview-icon analytics-icon">
                        <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M4 11H2v3h2v-3zm5-4H7v7h2V7zm5-5v12h-2V2h2zm-2-1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1h-2zM6 7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zm-5 4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-3z"/>
                        </svg>
                    </div>
                    <h3>Market Analytics</h3>
                    <span class="feature-preview-trend up">+8.3%</span>
                </div>
                <div class="feature-preview-stats">
                    <div class="stat-item">
                        <span class="stat-number">$425K</span>
                        <span class="stat-label">Avg Home Price</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">18</span>
                        <span class="stat-label">Days on Market</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">94.2%</span>
                        <span class="stat-label">Price to List Ratio</span>
                    </div>
                </div>
                <div class="feature-preview-footer">
                    <a href="/analytics" class="feature-preview-link">View Market Data</a>
                </div>
            </div>

        </div>
    </div>

    
    
    {% if session.user_plan == 'free' %}
    <div class="plan-upgrade">
        <h3>Upgrade to Pro Plan</h3>
        <p>Get advanced CRM features, unlimited contacts, and marketing tools</p>
        <a href="#" class="btn" style="background: white; color: #f59e0b; font-weight: 600;" onclick="showPricingModal(); return false;">View Plans & Pricing</a>
    </div>
    {% endif %}
</div>

<!-- Welcome Modal for New Google Users -->
<div class="welcome-overlay" id="welcome-modal">
    <div class="welcome-modal">
        <div class="welcome-icon">
            <svg width="60" height="60" fill="#10b981" viewBox="0 0 16 16">
                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.061L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
            </svg>
        </div>
        <h2>Welcome to Real Estate Office Pro! 🎉</h2>
        <p>Your account has been created successfully.</p>
        <p class="welcome-subtitle">Get ready to discover amazing office software!</p>
        <button class="btn-welcome" onclick="closeWelcome()">Let's Get Started</button>
    </div>
</div>

<!-- Pricing Modal -->
<div class="modal-overlay" id="pricing-modal">
    <div class="modal" style="max-width: 900px;">
        <button class="close-modal" onclick="hidePricingModal()" aria-label="Close">×</button>
        <h2 style="text-align: center; margin-bottom: 1rem; font-size: 2rem; color: #1e293b;">Choose Your Plan</h2>
        <p style="text-align: center; color: #64748b; margin-bottom: 2rem;">Upgrade to unlock powerful features and grow your real estate business</p>
        
        <div class="pricing-grid">
            <!-- Starter Plan -->
            <div class="pricing-card">
                <div class="plan-header">
                    <h3 class="plan-name">Starter</h3>
                    <div class="plan-price">
                        <span class="currency">$</span>
                        <span class="amount">29</span>
                        <span class="period">/month</span>
                    </div>
                    <p class="plan-description">Perfect for new agents getting started</p>
                </div>
                <ul class="plan-features">
                    <li><span class="check">✓</span> Up to 50 CRM contacts</li>
                    <li><span class="check">✓</span> Basic client management</li>
                    <li><span class="check">✓</span> Calendar & scheduling</li>
                    <li><span class="check">✓</span> Email notifications</li>
                    <li><span class="check">✓</span> Mobile app access</li>
                    <li><span class="check">✓</span> Basic market analytics</li>
                    <li class="disabled"><span class="x">✗</span> Advanced CRM features</li>
                    <li class="disabled"><span class="x">✗</span> WhatsApp integration</li>
                    <li class="disabled"><span class="x">✗</span> Marketing tools</li>
                </ul>
                <button class="plan-button" onclick="selectPlan('starter')">Start Free Trial</button>
            </div>
            
            <!-- Professional Plan -->
            <div class="pricing-card featured">
                <div class="popular-badge">Most Popular</div>
                <div class="plan-header">
                    <h3 class="plan-name">Professional</h3>
                    <div class="plan-price">
                        <span class="currency">$</span>
                        <span class="amount">79</span>
                        <span class="period">/month</span>
                    </div>
                    <p class="plan-description">Best for active agents and small teams</p>
                </div>
                <ul class="plan-features">
                    <li><span class="check">✓</span> <strong>Unlimited</strong> CRM contacts</li>
                    <li><span class="check">✓</span> Advanced client management</li>
                    <li><span class="check">✓</span> Marketing flyer generator</li>
                    <li><span class="check">✓</span> E-signature integration</li>
                    <li><span class="check">✓</span> Advanced market analytics</li>
                    <li><span class="check">✓</span> Priority customer support</li>
                    <li><span class="check">✓</span> Email campaign tools</li>
                    <li><span class="check">✓</span> Document management</li>
                    <li><span class="check">✓</span> Transaction tracking</li>
                </ul>
                <button class="plan-button featured-btn" onclick="selectPlan('professional')">Start Free Trial</button>
            </div>
            
            <!-- Enterprise Plan -->
            <div class="pricing-card">
                <div class="plan-header">
                    <h3 class="plan-name">Enterprise</h3>
                    <div class="plan-price">
                        <span class="currency">$</span>
                        <span class="amount">149</span>
                        <span class="period">/month</span>
                    </div>
                    <p class="plan-description">For teams and high-volume agents</p>
                </div>
                <ul class="plan-features">
                    <li><span class="check">✓</span> Everything in Professional</li>
                    <li><span class="check">✓</span> Team collaboration tools</li>
                    <li><span class="check">✓</span> Advanced lead management</li>
                    <li><span class="check">✓</span> Custom branding options</li>
                    <li><span class="check">✓</span> API access</li>
                    <li><span class="check">✓</span> Dedicated account manager</li>
                    <li><span class="check">✓</span> White-label options</li>
                    <li><span class="check">✓</span> Advanced reporting & analytics</li>
                    <li><span class="check">✓</span> Phone support</li>
                </ul>
                <button class="plan-button" onclick="selectPlan('enterprise')">Start Free Trial</button>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 2rem;">
            <p style="color: #64748b; font-size: 0.875rem;">
                <strong>7-day money-back guarantee</strong> • No setup fees • Cancel anytime
            </p>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal-overlay" id="payment-modal">
    <div class="modal" style="max-width: 500px;">
        <button class="close-modal" onclick="hidePaymentModal()" aria-label="Close">×</button>
        <h3 style="margin-bottom: 1.5rem;">Complete Your Upgrade</h3>
        
        <div class="selected-plan-summary">
            <h4 id="selected-plan-name">Professional Plan</h4>
            <p id="selected-plan-price">$29/month</p>
        </div>
        
        <form id="payment-form">
            <div class="form-group">
                <label for="card-name">Cardholder Name</label>
                <input type="text" id="card-name" placeholder="John Doe" required>
            </div>
            
            <div class="form-group">
                <label for="card-number">Card Number</label>
                <input type="text" id="card-number" placeholder="1234 5678 9012 3456" maxlength="19" required>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label for="card-expiry">Expiry Date</label>
                    <input type="text" id="card-expiry" placeholder="MM/YY" maxlength="5" required>
                </div>
                <div class="form-group">
                    <label for="card-cvv">CVV</label>
                    <input type="text" id="card-cvv" placeholder="123" maxlength="4" required>
                </div>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" required> I agree to the <a href="/terms" style="color: #2563eb;">Terms of Service</a> and <a href="/privacy" style="color: #2563eb;">Privacy Policy</a>
                </label>
            </div>
            
            <button type="submit" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.1rem;">
                Complete Payment
            </button>
            
            <p style="text-align: center; margin-top: 1rem; color: #64748b; font-size: 0.875rem;">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2364748b' viewBox='0 0 16 16'%3E%3Cpath d='M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z'/%3E%3C/svg%3E" alt="Secure" style="vertical-align: middle; margin-right: 4px;">
                Secure payment powered by Stripe
            </p>
        </form>
    </div>
</div>

<!-- Add Action Modal -->
<div class="modal-overlay" id="add-modal">
    <div class="modal">
        <h3>Add New Quick Action</h3>
        <form id="add-action-form">
            <div class="form-group">
                <label for="tool-select">Select a Tool</label>
                <select id="tool-select" required>
                    <option value="">Choose a tool to add...</option>
                    <option value="clients">Customer Relationship Management</option>
                    <option value="calendar">Calendar & Scheduling</option>
                    <option value="messages">Messages</option>
                    <option value="marketing">Marketing Tools</option>
                    <option value="documents">Documents & E-sign</option>
                    <option value="analytics">Market Analytics</option>
                    <optgroup label="Additional Tools">
                        <option value="client-portal">Client Portal</option>
                        <option value="email-templates">Email Templates</option>
                        <option value="virtual-tours">Virtual Tour Creator</option>
                        <option value="commission-calculator">Commission Calculator</option>
                        <option value="transaction-manager">Transaction Manager</option>
                        <option value="open-house">Open House Manager</option>
                        <option value="lead-capture">Lead Capture Forms</option>
                    </optgroup>
                </select>
            </div>
            
            <div id="tool-preview" style="display: none;">
                <div class="form-group">
                    <label>Preview</label>
                    <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1rem; display: flex; align-items: center; gap: 1rem;">
                        <div class="action-icon emoji-icon" id="preview-icon" style="width: 48px; height: 48px;">-</div>
                        <div>
                            <h4 id="preview-title" style="margin: 0 0 0.25rem 0; font-size: 1rem; font-weight: 600; color: #1e293b;">-</h4>
                            <p id="preview-description" style="margin: 0; font-size: 0.875rem; color: #64748b;">-</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="hideAddModal()">Cancel</button>
                <button type="submit" class="btn-save" disabled>Add to Dashboard</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Quick Actions Management
    let editMode = false;
    let selectedTool = null;
    let draggedElement = null;
    
    // Available tools database (PROPERTY SEARCH TOOLS REMOVED)
    const availableTools = {
        // Main Navigation Tools
        'clients': {
            title: 'Client Management',
            description: 'Manage contacts and track interactions',
            url: '/crm',
            icon: 'CRM'
        },
        'calendar': {
            title: 'Calendar & Scheduling',
            description: 'Book appointments and showings',
            url: '/calendar',
            icon: 'CS'
        },
        'documents': {
            title: 'Documents & E-sign',
            description: 'Manage contracts and digital signatures',
            url: '/documents',
            icon: 'DE'
        },
        'analytics': {
            title: 'Market Analytics',
            description: 'View market trends and pricing data',
            url: '/analytics',
            icon: 'MA'
        },
        'messages': {
            title: 'Messages',
            description: 'Communicate with clients and leads',
            url: '/messages',
            icon: '💬'
        },
        'marketing': {
            title: 'Marketing Tools',
            description: 'Create flyers and social media content',
            url: '/marketing',
            icon: '🎯'
        },
        // Additional Tools
        'lead-capture': {
            title: 'Lead Capture Forms',
            description: 'Create and manage lead generation forms',
            url: '/lead-capture',
            icon: '📝'
        },
        'client-portal': {
            title: 'Client Portal',
            description: 'Give clients access to their information',
            url: '/client-portal',
            icon: '👥'
        },
        'email-templates': {
            title: 'Email Templates',
            description: 'Pre-written email templates for quick communication',
            url: '/email-templates',
            icon: '📧'
        },
        'virtual-tours': {
            title: 'Virtual Tour Creator',
            description: 'Create immersive virtual tours',
            url: '/virtual-tours',
            icon: '🎥'
        },
        'commission-calculator': {
            title: 'Commission Calculator',
            description: 'Calculate commissions and splits',
            url: '/commission-calculator',
            icon: '🧮'
        },
        'transaction-manager': {
            title: 'Transaction Manager',
            description: 'Manage all your real estate transactions',
            url: '/transactions',
            icon: '📑'
        },
        'open-house': {
            title: 'Open House Manager',
            description: 'Organize and track open house events',
            url: '/open-house',
            icon: '🏠'
        }
    };
    
    // Default quick actions (PROPERTY TOOLS REMOVED)
    const defaultActions = [
        {
            id: 'clients',
            title: 'Client Management',
            description: 'Manage contacts and track interactions',
            url: '/crm',
            icon: 'C'
        },
        {
            id: 'calendar',
            title: 'Calendar & Scheduling',
            description: 'Book appointments and showings',
            url: '/calendar',
            icon: 'S'
        },
        {
            id: 'messages',
            title: 'Messages',
            description: 'Communicate with clients and leads',
            url: '/messages',
            icon: 'M'
        },
        {
            id: 'marketing',
            title: 'Marketing Tools',
            description: 'Create flyers and social media content',
            url: '/marketing',
            icon: 'K'
        },
        {
            id: 'analytics',
            title: 'Market Analytics',
            description: 'View market trends and pricing data',
            url: '/analytics',
            icon: 'A'
        },
        {
            id: 'documents',
            title: 'Documents & E-sign',
            description: 'Manage contracts and digital signatures',
            url: '/documents',
            icon: 'D'
        }
    ];
    
    // Load actions from storage or use defaults
    let quickActions = []; // Will be loaded from server
    
    // Render quick actions
    function renderQuickActions() {
        const grid = document.getElementById('actions-grid');
        grid.innerHTML = quickActions.map(action => {
            // Check if icon is an emoji
            const isEmoji = action.icon.length > 1 || /[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u.test(action.icon);
            
            return `
            <a href="${editMode ? '#' : action.url}" 
               class="action-card ${editMode ? 'edit-mode' : ''}" 
               draggable="${editMode}"
               data-id="${action.id}"
               ${editMode ? 'onclick="return false;"' : ''}>
                <button class="delete-btn" onclick="deleteAction('${action.id}')" aria-label="Delete">×</button>
                <div class="action-icon ${isEmoji ? 'emoji-icon' : ''}">${action.icon}</div>
                <div class="action-content">
                    <h3>${action.title}</h3>
                    <p>${action.description}</p>
                </div>
            </a>
        `}).join('');
        
        if (editMode) {
            grid.innerHTML += `
                <div class="add-action-card" onclick="showAddModal()">
                    <div class="add-action-content">
                        <div class="add-action-icon">+</div>
                        <div>Add New Action</div>
                    </div>
                </div>
            `;
            
            // Add drag and drop event listeners
            const cards = grid.querySelectorAll('.action-card');
            cards.forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragenter', handleDragEnter);
                card.addEventListener('dragleave', handleDragLeave);
            });
        }
    }
    
    // Load quick actions from server
    async function loadQuickActions() {
        try {
            const response = await fetch('/auth/api/user/quick-actions');
            const data = await response.json();
            
            if (data.success) {
                quickActions = data.quick_actions;
            } else {
                quickActions = defaultActions;
            }
        } catch (error) {
            console.error('Error loading quick actions:', error);
            quickActions = defaultActions;
        }
        
        renderQuickActions();
    }

    // Save quick actions to server
    async function saveQuickActions() {
        try {
            const response = await fetch('/auth/api/user/quick-actions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ quick_actions: quickActions })
            });
            
            const data = await response.json();
            if (!data.success) {
                console.error('Failed to save quick actions');
            }
        } catch (error) {
            console.error('Error saving quick actions:', error);
        }
    }
    
    // Define all functions first
    window.toggleEditMode = function() {
        editMode = !editMode;
        const editBtn = document.getElementById('edit-btn');
        editBtn.textContent = editMode ? 'Done Editing' : 'Edit Layout';
        editBtn.classList.toggle('active', editMode);
        renderQuickActions();
    }

    window.deleteAction = async function(id) {
        if (confirm('Are you sure you want to remove this quick action?')) {
            quickActions = quickActions.filter(action => action.id !== id);
            await saveQuickActions();
            renderQuickActions();
        }
    }
    
    // Drag and drop handlers
    function handleDragStart(e) {
        draggedElement = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
    }
    
    function handleDragEnd(e) {
        this.classList.remove('dragging');
        
        // Remove all drag-over classes
        const cards = document.querySelectorAll('.action-card');
        cards.forEach(card => card.classList.remove('drag-over'));
    }
    
    function handleDragOver(e) {
        if (e.preventDefault) {
            e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';
        return false;
    }
    
    function handleDragEnter(e) {
        if (this !== draggedElement) {
            this.classList.add('drag-over');
        }
    }
    
    function handleDragLeave(e) {
        this.classList.remove('drag-over');
    }
    
    async function handleDrop(e) {
        if (e.stopPropagation) {
            e.stopPropagation();
        }
        
        if (draggedElement !== this) {
            const draggedId = draggedElement.getAttribute('data-id');
            const targetId = this.getAttribute('data-id');
            
            const draggedIndex = quickActions.findIndex(a => a.id === draggedId);
            const targetIndex = quickActions.findIndex(a => a.id === targetId);
            
            if (draggedIndex !== -1 && targetIndex !== -1) {
                // Swap positions
                const draggedAction = quickActions[draggedIndex];
                quickActions.splice(draggedIndex, 1);
                quickActions.splice(targetIndex, 0, draggedAction);
                
                await saveQuickActions();
                renderQuickActions();
            }
        }
        
        return false;
    }
    
    // Modal functions
    window.showAddModal = function() {
        document.getElementById('add-modal').classList.add('active');
        document.getElementById('tool-select').focus();
    }
    
    window.hideAddModal = function() {
        document.getElementById('add-modal').classList.remove('active');
        document.getElementById('add-action-form').reset();
        document.getElementById('tool-preview').style.display = 'none';
        document.querySelector('.btn-save').disabled = true;
        selectedTool = null;
    }
    
    // Handle tool selection
    document.getElementById('tool-select').addEventListener('change', function(e) {
        const toolId = e.target.value;
        
        if (toolId && availableTools[toolId]) {
            selectedTool = availableTools[toolId];
            
            // Show preview
            document.getElementById('tool-preview').style.display = 'block';
            document.getElementById('preview-icon').textContent = selectedTool.icon;
            document.getElementById('preview-title').textContent = selectedTool.title;
            document.getElementById('preview-description').textContent = selectedTool.description;
            
            // Enable save button
            document.querySelector('.btn-save').disabled = false;
        } else {
            document.getElementById('tool-preview').style.display = 'none';
            document.querySelector('.btn-save').disabled = true;
            selectedTool = null;
        }
    });
    
    // Handle add action form submission
    document.getElementById('add-action-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!selectedTool) return;
        
        const toolId = document.getElementById('tool-select').value;
        
        // Check if tool is already added
        if (quickActions.some(action => action.id === toolId)) {
            alert('This tool is already in your Quick Actions!');
            return;
        }
        
        const newAction = {
            id: toolId,
            title: selectedTool.title,
            description: selectedTool.description,
            url: selectedTool.url,
            icon: selectedTool.icon
        };
        
        quickActions.push(newAction);
        await saveQuickActions();
        
        hideAddModal();
        renderQuickActions();
    });
    
    // Close modal on overlay click
    document.getElementById('add-modal').addEventListener('click', (e) => {
        if (e.target.id === 'add-modal') {
            hideAddModal();
        }
    });
    
    // CRM Stats Loading Function
    async function loadCRMStats() {
        try {
            const response = await fetch('/api/clients/stats', {
                method: 'GET',
                credentials: 'same-origin',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Find the CRM preview card
                const crmCard = document.querySelector('.feature-preview-card:has(.crm-icon)');
                
                if (crmCard) {
                    // Update Total Leads
                    const totalLeadsElement = crmCard.querySelector('.stat-item:nth-child(1) .stat-number');
                    if (totalLeadsElement) {
                        animateNumber(totalLeadsElement, parseInt(totalLeadsElement.textContent) || 0, data.stats.active_leads);
                    }
                    
                    // Update Active Clients
                    const activeClientsElement = crmCard.querySelector('.stat-item:nth-child(2) .stat-number');
                    if (activeClientsElement) {
                        animateNumber(activeClientsElement, parseInt(activeClientsElement.textContent) || 0, data.stats.qualified_buyers);
                    }
                    
                    // Update Need Follow-up
                    const followUpElement = crmCard.querySelector('.stat-item:nth-child(3) .stat-number');
                    if (followUpElement) {
                        animateNumber(followUpElement, parseInt(followUpElement.textContent) || 0, data.stats.hot_prospects);
                    }
                    
                    // Update trend to show time period or status
                    const trendElement = crmCard.querySelector('.feature-preview-trend');
                    if (trendElement) {
                        // Show different status based on activity
                        if (data.stats.new_clients_30d > 0) {
                            trendElement.className = 'feature-preview-trend up';
                            trendElement.textContent = `${data.stats.new_clients_30d} new this month`;
                        } else if (data.stats.hot_prospects > 0) {
                            trendElement.className = 'feature-preview-trend down';
                            trendElement.textContent = `${data.stats.hot_prospects} need attention`;
                        } else {
                            trendElement.className = 'feature-preview-trend neutral';
                            trendElement.textContent = 'All up to date';
                        }
                    }
                    
                    // Update title if no clients
                    if (data.stats.total_clients === 0) {
                        const titleElement = crmCard.querySelector('h3');
                        titleElement.innerHTML = 'Client Management <small style="font-size: 0.75rem; color: #64748b;">(Get Started)</small>';
                    }
                }
            }
        } catch (error) {
            console.error('Error loading CRM stats:', error);
        }
    }

    // Calendar Stats Loading Function
    // Fixed Calendar Stats Loading Function
    async function loadCalendarStats() {
        try {
            const response = await fetch('/api/calendar/stats', {
                method: 'GET',
                credentials: 'same-origin',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            console.log('Calendar stats data:', data); // Debug log
            
            if (data.success || data.stats) {
                // Find the Calendar preview card
                const calendarCard = document.querySelector('.feature-preview-card:has(.calendar-icon)');
                
                if (calendarCard) {
                    // Get stats object - handle different response structures
                    const stats = data.stats || data;
                    
                    // Update Today's Events
                    const todayElement = calendarCard.querySelector('.stat-item:nth-child(1) .stat-number');
                    if (todayElement) {
                        const todayCount = parseInt(stats.today_events || stats.today || stats.events_today || 0);
                        if (!isNaN(todayCount)) {
                            animateNumber(todayElement, 0, todayCount);
                        } else {
                            todayElement.textContent = '0';
                        }
                    }
                    
                    // Update This Week
                    const weekElement = calendarCard.querySelector('.stat-item:nth-child(2) .stat-number');
                    if (weekElement) {
                        const weekCount = parseInt(stats.week_events || stats.this_week || stats.events_this_week || 0);
                        if (!isNaN(weekCount)) {
                            animateNumber(weekElement, 0, weekCount);
                        } else {
                            weekElement.textContent = '0';
                        }
                    }
                    
                    // Update Total This Month
                    const monthElement = calendarCard.querySelector('.stat-item:nth-child(3) .stat-number');
                    if (monthElement) {
                        const monthCount = parseInt(stats.month_events || stats.this_month || stats.events_this_month || stats.total_month || 0);
                        if (!isNaN(monthCount)) {
                            animateNumber(monthElement, 0, monthCount);
                        } else {
                            monthElement.textContent = '0';
                        }
                    }
                    
                    // Update trend to show status
                    const trendElement = calendarCard.querySelector('.feature-preview-trend');
                    if (trendElement) {
                        const todayCount = parseInt(stats.today_events || stats.today || 0);
                        const upcomingCount = parseInt(stats.upcoming_24h || stats.upcoming || 0);
                        
                        if (upcomingCount > 0) {
                            trendElement.className = 'feature-preview-trend up';
                            trendElement.textContent = `${upcomingCount} upcoming`;
                        } else if (todayCount > 0) {
                            trendElement.className = 'feature-preview-trend neutral';
                            trendElement.textContent = `${todayCount} today`;
                        } else {
                            trendElement.className = 'feature-preview-trend neutral';
                            trendElement.textContent = 'No events today';
                        }
                    }
                    
                    // Update labels
                    const statLabels = calendarCard.querySelectorAll('.stat-label');
                    if (statLabels.length >= 3) {
                        statLabels[0].textContent = "Today's Events";
                        statLabels[1].textContent = "This Week";
                        statLabels[2].textContent = "Total This Month";
                    }
                }
            } else {
                console.error('Invalid calendar stats response:', data);
                // Set all values to 0 if there's an error
                setCalendarStatsToZero();
            }
        } catch (error) {
            console.error('Error loading calendar stats:', error);
            setCalendarStatsToZero();
        }
    }

    // Helper function to set all stats to 0
    function setCalendarStatsToZero() {
        const calendarCard = document.querySelector('.feature-preview-card:has(.calendar-icon)');
        if (calendarCard) {
            const statNumbers = calendarCard.querySelectorAll('.stat-number');
            statNumbers.forEach(el => el.textContent = '0');
            
            const trendElement = calendarCard.querySelector('.feature-preview-trend');
            if (trendElement) {
                trendElement.className = 'feature-preview-trend neutral';
                trendElement.textContent = 'No events today';
            }
        }
    }

    // Simple test function to check if the API is working
    async function testCalendarAPI() {
        console.log('Testing Calendar API...');
        
        // Test stats endpoint
        try {
            const statsResponse = await fetch('/api/calendar/stats');
            const statsData = await statsResponse.json();
            console.log('Stats endpoint response:', statsData);
        } catch (error) {
            console.error('Stats endpoint error:', error);
        }
        
        // Test events endpoint
        try {
            const eventsResponse = await fetch('/api/calendar/events');
            const eventsData = await eventsResponse.json();
            console.log('Events endpoint response:', eventsData);
            console.log('Number of events:', eventsData.events ? eventsData.events.length : 0);
        } catch (error) {
            console.error('Events endpoint error:', error);
        }
    }

    // Optional: Add a more detailed calendar widget to dashboard
    function addCalendarWidget() {
        // This function could add a mini calendar or upcoming events list to the dashboard
        // For now, we'll just ensure the stats are loaded
        console.log('Calendar widget ready for future implementation');
    }

    // Enhanced upcoming events display (optional)
    async function loadUpcomingEventsForDashboard() {
        try {
            const response = await fetch('/api/calendar/events/upcoming?limit=5');
            const data = await response.json();
            
            if (data.success && data.events && data.events.length > 0) {
                // You could add a small upcoming events section to the dashboard
                // This is just a placeholder for future enhancement
                console.log('Upcoming events loaded:', data.events.length);
            }
        } catch (error) {
            console.error('Error loading upcoming events:', error);
        }
    }
        
        // Animate number changes
        function animateNumber(element, start, end) {
            const duration = 500; // ms
            const startTime = performance.now();
            
            const animate = (currentTime) => {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                const current = Math.floor(start + (end - start) * progress);
                element.textContent = current;
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                }
            };
            
            requestAnimationFrame(animate);
        }

    // Welcome Modal Functions for Google Users
    function closeWelcome() {
        document.getElementById('welcome-modal').classList.remove('show');
    }

    // Show welcome modal for new Google users only
    {% if session.get('show_welcome') %}
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🎉 Showing welcome modal for new Google user!');
        
        // Show welcome modal
        document.getElementById('welcome-modal').classList.add('show');
        
        // Clear the session flag so it only shows once
        fetch('/auth/clear-welcome-flag', { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        }).catch(e => console.log('Welcome flag clear failed:', e));
    });
    {% endif %}
        
        // Initialize - Load quick actions when page loads
        document.addEventListener('DOMContentLoaded', () => {
        loadQuickActions();
        
        // Load CRM stats
        loadCRMStats();
        
        // Load Calendar stats
        loadCalendarStats();
        
        // Refresh CRM stats every 60 seconds
        setInterval(loadCRMStats, 60000);
        
        // Refresh Calendar stats every 60 seconds  
        setInterval(loadCalendarStats, 60000);
            
            // Add event listener for edit button
            document.getElementById('edit-btn').addEventListener('click', toggleEditMode);
        });
        
        // Pricing Modal Functions
        let selectedPlan = null;
        
        window.showPricingModal = function() {
            document.getElementById('pricing-modal').classList.add('active');
        }
        
        window.hidePricingModal = function() {
            document.getElementById('pricing-modal').classList.remove('active');
        }
        
        window.showPaymentModal = function() {
            document.getElementById('payment-modal').classList.add('active');
        }
        
        window.hidePaymentModal = function() {
            document.getElementById('payment-modal').classList.remove('active');
            document.getElementById('payment-form').reset();
        }
        
        window.selectPlan = function(plan) {
            selectedPlan = plan;
            
            // Update payment modal with selected plan
            const planDetails = {
                starter: {
                    name: 'Starter Plan',
                    price: '$29/month'
                },
                professional: {
                    name: 'Professional Plan',
                    price: '$79/month'
                },
                enterprise: {
                    name: 'Enterprise Plan',
                    price: '$149/month'
                }
            };
            
            document.getElementById('selected-plan-name').textContent = planDetails[plan].name;
            document.getElementById('selected-plan-price').textContent = planDetails[plan].price;
            
            // Hide pricing modal and show payment modal
            hidePricingModal();
            showPaymentModal();
        }
        
        // Close modals on overlay click
        document.getElementById('pricing-modal').addEventListener('click', (e) => {
            if (e.target.id === 'pricing-modal') {
                hidePricingModal();
            }
        });
        
        document.getElementById('payment-modal').addEventListener('click', (e) => {
            if (e.target.id === 'payment-modal') {
                hidePaymentModal();
            }
        });
        
        // Format card number input
        document.getElementById('card-number').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formattedValue;
        });
        
        // Format expiry date input
        document.getElementById('card-expiry').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value;
        });
        
        // Only allow numbers for CVV
        document.getElementById('card-cvv').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '');
        });
        
        // Handle payment form submission
        document.getElementById('payment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Processing...';
            submitBtn.disabled = true;
            
            // Simulate payment processing
            setTimeout(() => {
                // Show success message
                hidePaymentModal();
                
                // Create success notification
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 2rem;
                    right: 2rem;
                    background: #10b981;
                    color: white;
                    padding: 1rem 2rem;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    z-index: 10000;
                    animation: slideIn 0.3s ease-out;
                `;
                notification.innerHTML = `
                    <strong>🎉 Upgrade Successful!</strong><br>
                    <span style="font-size: 0.875rem;">Your account has been upgraded to ${selectedPlan === 'professional' ? 'Professional' : 'Enterprise'} plan.</span>
                `;
                document.body.appendChild(notification);
                
                // Remove notification after 5 seconds
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => notification.remove(), 300);
                }, 5000);
                
                // Update UI to reflect new plan
                const planUpgradeSection = document.querySelector('.plan-upgrade');
                if (planUpgradeSection) {
                    planUpgradeSection.style.display = 'none';
                }
                
                // Update stats to show new plan
                const planStat = document.querySelector('.stat-value');
                if (planStat && planStat.parentElement.querySelector('h3').textContent === 'Current Plan') {
                    planStat.textContent = selectedPlan.toUpperCase();
                }
                
                // Reset button
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }, 2000);
        });
        
        // Add animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
</script>
{% endblock %}